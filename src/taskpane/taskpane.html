<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DMS Add-in</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>

    <!-- Fluent UI CSS -->
    <link
      rel="stylesheet"
      href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"
    />

    <!-- Template styles -->
    <link href="taskpane.css" rel="stylesheet" type="text/css" />
  </head>

  <body class="ms-font-m ms-welcome ms-Fabric">
    <main id="app-body">
      <div id="text-item"></div>
      <div id="dms-button" class="ms-Button ms-Button-main">
        <span class="ms-Button-label">Sync to DMS</span>
      </div>

      <div id="loader-area" class="loader"></div>
    </main>

    <script>
      let insertAt, dmsButton, loaderIcon;

      Office.onReady((info) => {
        if (info.host === Office.HostType.Outlook) {
          insertAt = document.getElementById("text-item");
          dmsButton = document.getElementById("dms-button");
          loaderIcon = document.getElementById("loader-area");

          syncWithDMS();
          document.getElementById("app-body").style.display = "flex";
        }
      });

      function insertAtStatus(value) {
        insertAt.style.display = value;
      }

      function dmsBtnStatus(value) {
        dmsButton.style.display = value;
      }

      function loaderStatus(value) {
        loaderIcon.style.display = value;
      }

      function setHTMLText(text) {
        insertAt.innerHTML = text;
      }

      function formatDateTime(dateTime) {
        const date = new Date(dateTime);
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        const hours = date.getHours() % 12 || 12; // Convert to 12-hour format
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const ampm = date.getHours() >= 12 ? "PM" : "AM";

        return `${day}/${month}/${year} , ${hours}:${minutes} ${ampm}`;
      }

      async function syncWithDMS() {
        const item = Office.context.mailbox.item;

        const emailData = {
          subject: item.subject,
          to: item.to,
          from: item.from,
          body: "N/A",
          attachments: await getAttachmentsContent(item),
          dateTimeCreated: item.dateTimeCreated,
        };

        item.body.getAsync(Office.CoercionType.Text, function (result) {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            emailData.body = result.value || "N/A";
          }

          if (emailData) {
            displayEmailData(emailData);
            loaderStatus("none");
            dmsBtnStatus("block");

            dmsButton.onclick = () => sendEmail(emailData);
          }
        });
      }

      function displayEmailData(data) {
        insertAtStatus("block");

        const addTextWithLineBreak = (label, value, isAttachment = false) => {
          const displayValue = value || "N/A";
          if (isAttachment) {
            return `
            <dl class="email-attachments">
              <dt>${label}</dt>
              <dd>${displayValue
                .split(", ")
                .map((name) => `<span class="attachment-item">${name}</span>`)
                .join(" ")}
              </dd>
            </dl>`;
          }
          return `<dl class="email-details">
            <dt>${label}</dt>
            <dd title="${displayValue}">${displayValue}</dd>
          </dl>`;
        };

        const emailDetails = [
          { label: "From: ", value: data?.from?.displayName },
          { label: "To: ", value: data?.to?.map((recipient) => recipient.emailAddress || "N/A").join(", ") },
          { label: "Subject: ", value: data?.subject },
          { label: "Created On: ", value: data?.dateTimeCreated ? formatDateTime(data.dateTimeCreated) : "N/A" },
          {
            label: "Attachments: ",
            value: data?.attachments?.map((file) => file.name || "N/A").join(", "),
            isAttachment: true,
          },
        ];

        const emailDetailsHtml = emailDetails
          .map((detail) => addTextWithLineBreak(detail.label, detail.value, detail.isAttachment))
          .join("");

        setHTMLText(emailDetailsHtml);
      }

      async function getAttachmentsContent(item) {
        if (!item.attachments || item.attachments.length === 0) return [];

        const attachments = [];
        for (const attachment of item.attachments) {
          if (attachment.attachmentType === "file") {
            const content = await getFileContent(attachment.id);
            attachments.push({
              id: attachment.id,
              name: attachment.name,
              contentType: attachment.contentType,
              size: attachment.size,
              attachmentType: attachment.attachmentType,
              content: content,
            });
          }
        }
        return attachments;
      }

      function getFileContent(attachmentId) {
        return new Promise((resolve, reject) => {
          const item = Office.context.mailbox.item;
          item.getAttachmentContentAsync(attachmentId, (result) => {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              resolve(result.value.content);
            } else {
              reject(new Error(`Error getting attachment content: ${result.error.message}`));
            }
          });
        });
      }

      async function sendEmail(emailData) {
        loaderStatus("block");
        insertAtStatus("block");

        dmsButton.classList.add("disabled");

        try {
          const response = await fetch("https://9992-182-181-149-99.ngrok-free.app/api/outlook/upload-document/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(emailData),
          });

          loaderStatus("none");
          const data = await response.json();

          if (response.ok) {
            dmsBtnStatus("none");
            setHTMLText(`<span style="color: green;">${data.message}</span>`);
          } else {
            handleError(response.status, response.statusText, data?.error);
          }
        } catch (error) {
          console.error("Error: ", error);
          loaderStatus("none");
          setHTMLText(`<span style="color: red;">${error.message}, please try again!</span>`);
        } finally {
          dmsButton.classList.remove("disabled");
        }
      }

      function handleError(status, statusText, errorMessage = "") {
        let errorMsg = `Error ${status}: ${statusText}`;

        switch (status) {
          case 404:
            errorMsg = errorMessage || "Resource not found, please try again!";
            break;
          case 401:
            errorMsg = "Unauthorized - Please check your authentication.";
            break;
          case 500:
            errorMsg = "Internal Server Error, please try again!";
            break;
          default:
            if (errorMessage) errorMsg = errorMessage;
            break;
        }

        setHTMLText(`<span style="color: red;">${errorMsg}</span>`);
      }
    </script>
  </body>
</html>
